---
title: "Census tract-level SVI in Philly (2019)"
output: 
    rmarkdown::html_vignette:
      code_folding: hide
vignette: >
  %\VignetteIndexEntry{Census tract-level SVI in Philly (2019)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Since SVI uses percentile ranks to summarise 16 census variables representing socioeconomic and demographic factors, it's important to keep in mind the result may be affected by what we are ranking each geographic unit against. 

For example, if we are interested in SVI in Philadelphia (county), PA at the census tract level for 2020, we could download the tract-level SVI result for PA from [CDC/ATSDR SVI database](https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html), which is ranking each tract against all tracts in PA. Alternatively, we could use findSVI to calculate tract-level SVI for Philadelphia county in PA for 2020, which is ranking each tract against all tracts in Philadelphia. Here, we'll compare what they would look like for both approaches, and discuss the potential implications.

# SVI using ranks against tracts in PA

After downloading the shapefile from CDC/ATSDR SVI database, we can read it in R using the [sf package](https://r-spatial.github.io/sf/index.html). This is the data for the whole Pennsylvania, so we'll filter by the county and only keep the data for Philadelphia (which happens to be the city itself). For the size of the package, I'm only including the Philadelphia data here (`cdc_svi_phl_2020`).

With the help of [leaflet](https://rstudio.github.io/leaflet/), we can create an interactive map to visualize the results:
```{r setup}
library(dplyr)
library(sf)
library(leaflet)
library(findSVI)
library(purrr)
library(htmltools)
library(ggplot2)
library(glue)
library(tidyr)
```

```{r}
# unzip("../../Pennsylvania.zip",
#   exdir = "pa_ct_2020_shapefile", junkpaths = T,
#   overwrite = F)
# 
# pa_ct_2020 <- st_read("pa_ct_2020_shapefile/SVI2020_PENNSYLVANIA_tract.shp")
# 
# cdc_svi_phl_2020 <- pa_ct_2020 %>%
#   select(1:7, contains("RPL_THEME")) %>% 
#   filter(RPL_THEMES>= 0,
#     COUNTY == "Philadelphia")
#
# #To avoid Warning: sf layer has inconsistent datum (+proj=longlat +datum=NAD83 +no_defs).
# #Need '+proj=longlat +datum=WGS84'
# st_crs(cdc_svi_phl_2020) <- 4326

load(system.file("extdata", "cdc_svi_phl_2020.rda", package = "findSVI"))

#set color palette
pal2 <- colorNumeric(
  palette = c("orange","navy"),
  domain = cdc_svi_phl_2020$RPL_THEMES
)


#set label
ct_label <- glue("<h3 style='margin: 0px'>{cdc_svi_phl_2020$LOCATION}</h3>
                    overall SVI: {cdc_svi_phl_2020$RPL_THEMES}") %>%
  map(~HTML(.x))


leaflet(cdc_svi_phl_2020) %>%
  addProviderTiles(providers$CartoDB.Voyager) %>%
  addPolygons(color = "white",
    weight = 0.5,
    smoothFactor = 0.5,
    opacity = 1,
    fillColor = ~pal2(RPL_THEMES),
    fillOpacity = 0.8,
    highlightOptions = highlightOptions(
      weight = 5,
      color = "white",
      fillOpacity = 0.8,
      bringToFront = TRUE),
    label = ct_label,
    labelOptions = labelOptions(
      style = list(
        "font-family" = "Fira Sans, sans-serif",
        "font-size" = "1.2em"
      ))
  ) %>%
  addLegend("bottomright",
    pal = pal2,
    values = ~RPL_THEMES,
    title = "Tract-level SVI in Philly (2020)<br>source:CDC/ATSDR",
    #labFormat = labelFormat(prefix = "$"),
    opacity = 1)

```

# SVI using ranks against tracts in Philly 

As mentioned in [Mapping SVI for spatial analysis](SVI-mapping.html), we could use `get_census_data()` and `get_svi()` to retrieve data with geometry and calculate SVI within Philadelphia at the census tract level for 2020. Similarly, we'll use an interactive map to visualize the results. 
```{r }
load(system.file("extdata", "pa_ct_2020_geo_svi.rda", package = "findSVI"))

svi <- pa_ct_2020_geo_svi %>% 
  select(GEOID, geometry, contains("RPL_theme"))

svi_clean <- svi %>% drop_na()

#above shows CRS NAD83, change to 4326 (WGS84) to avoid warning as below:
#Warning: sf layer has inconsistent datum (+proj=longlat +datum=NAD83 +no_defs).
#Need '+proj=longlat +datum=WGS84'
st_crs(svi_clean) <- 4326

#set color palette
pal2 <- colorNumeric(
  palette = c("orange","navy"),
  domain = svi_clean$RPL_themes
)

#set label
ct_label2 <- glue("<h3 style='margin: 0px'>{svi_clean$GEOID}</h3>
                    overall SVI: {svi_clean$RPL_themes}") %>%
  map(~HTML(.x))

leaflet(svi_clean) %>% 
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addPolygons(color = "white", 
              weight = 0.5,
              smoothFactor = 0.5,
              opacity = 1,
              fillColor = ~pal2(RPL_themes),
              fillOpacity = 0.8,
              highlightOptions = highlightOptions(
                weight = 5,
                color = "white",
                fillOpacity = 0.8,
                bringToFront = TRUE),
              label = ct_label2,
              labelOptions = labelOptions(
                style = list(
                  "font-family" = "Fira Sans, sans-serif",
                  "font-size" = "1.2em"
                ))
              ) %>% 
  addLegend("bottomright",
            pal = pal2,
            values = ~RPL_themes,
            title = "Tract-level SVI in Philly (2020)<br>source: Census, findSVI",
            #labFormat = labelFormat(prefix = "$"),
            opacity = 1)


```

# Potential implications

The CDC/ATSDR SVI database offers valuable insights into community vulnerabilities across the United States and each state, including Pennsylvania. However, when examining the social vulnerability within a smaller region, especially metropolitan areas/cities like Philadelphia, a more nuanced approach may be necessary to uncover the disparities between different communities.

As seen in the example above, SVI using ranks against tracts in PA shows an overall higher SVI (darker color), whereas SVI using ranks against tracts in Philly shows wider color range, revealing more noticeable difference among the tracts.

If we plot out both versions of overall SVI for each tract, we can also observe an interesting pattern, where they correlate well at both ends of the SVI spectrum but correlate poorly in the middle. 

```{r}
join_svi <- cdc_svi_phl_2020 %>%
  st_drop_geometry() %>% 
  rename(
    GEOID = FIPS,
    CDC_SVI = RPL_THEMES,
    CDC_SVI1 = RPL_THEME1,
    CDC_SVI2 = RPL_THEME2,
    CDC_SVI3 = RPL_THEME3,
    CDC_SVI4 = RPL_THEME4
  ) %>%
    left_join(svi_clean %>% 
        st_drop_geometry() %>% 
        rename(findSVI_SVI = RPL_themes), 
      by = "GEOID") 


join_svi %>% 
  ggplot(aes(x = CDC_SVI, y = findSVI_SVI, color = findSVI_SVI)) +
  geom_point()+
  scale_color_gradient(low = "orange", high = "navy")+
  geom_abline(slope = 1, intercept = 0, color = 'orange', size= 0.5)+
  labs(title = "Tract-level overall SVI in Philadelphia (2020)",
       subtitle= "Ranking aganist tracts in PA (CDC) vs. \nranking against tracts in Philadelphia (findSVI)",
    x = "CDC",
    y = "findSVI",
    color = "Overall SVI")+
  theme(
    text = element_text(size = 13),
    plot.title = element_text(size = 16, hjust = 0, face = "bold"),
    plot.subtitle = element_text(color = "#4D4948", size = 12, hjust = 0),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 13)
  )

```

In this case, comparing tracts within Philadelphia enables a more granular analysis to better understand the relative social vulnerability among communities. This approach may help not only to target interventions and resources where they are most needed in crisis management, but also to enhance public health research using SVI as a metric.
