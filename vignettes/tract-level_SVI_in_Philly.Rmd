---
title: "Putting local SVI in context"
output: 
  rmarkdown::html_vignette:
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Putting local SVI in context}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Since SVI uses percentile ranks to summarise 16 census variables representing socioeconomic and demographic factors, it's important to keep in mind the result may be affected by what we are ranking each geographic unit against.

For example, if we are interested in SVI for Philadelphia (county), PA at the census tract level for 2020, we could download the tract-level SVI result for PA from [CDC/ATSDR SVI database](https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html), which is ranking each tract against all tracts in PA. Alternatively, we could use findSVI to calculate tract-level SVI for Philadelphia county in PA for 2020, which is ranking each tract against all tracts in Philadelphia. Here, we'll compare what they would look like for both approaches, and discuss the potential implications.

```{r setup, warning=FALSE, message=FALSE}
library(dplyr)
library(findSVI)
library(ggplot2)
library(tidyr)
```

# SVI using ranks against tracts in PA

On the CDC/ATSDR SVI database, SVI results are available in the format of shapefile and data table (.csv). After downloading and importing the data for the whole Pennsylvania into R (using the [sf package](https://r-spatial.github.io/sf/index.html for shapefile), we'll filter by the county and only keep the data for Philadelphia (which happens to be the city itself).

```{r, eval=FALSE}
#source: https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html

#For shapefile
unzip("../../../Pennsylvania.zip",
  exdir = "pa_ct_2020_shapefile", junkpaths = T,
  overwrite = F)

cdc_svi_pa_ct_2020 <- sf::st_read("pa_ct_2020_shapefile/SVI2020_PENNSYLVANIA_tract.shp")

#For csv
cdc_svi_pa_ct_2020 <- readr::read_csv("../Pennsylvania.csv")

```
```{r, echo=FALSE}
load(system.file("extdata", "cdc_svi_pa_ct_2020.rda", package = "findSVI"))
#no geometry
```
```{r}
cdc_svi_phl_2020 <- cdc_svi_pa_ct_2020 %>%
  select(1:7, contains("RPL_THEME")) %>%
  #CDC use -999 as NAs
  filter(RPL_THEMES>= 0,
    COUNTY == "Philadelphia")

glimpse(cdc_svi_phl_2020)

```

As a proof of concept, we'll use findSVI to reproduce CDC/ATSDR's version of tract-level SVI using percentile ranks aganist all tracts in PA, and select the tracts in Philadelphia county. Putting both versions of SVI on a scatterplot, we can see they are highly consistent. 

```{r, eval=FALSE}
pa_ct_raw2020 <- get_census_data(
  2020,
  state = "PA",
  geography = "tract"
  )

pa_ct_svi_2020 <- get_svi(2020, pa_ct_raw2020)

phl_ct_2020_svi_PA <- pa_ct_svi_2020 %>%
  filter(str_detect(NAME, "Philadelphia County"))
```

```{r, echo=FALSE}
load(system.file("extdata", "phl_ct_2020_svi_PA.rda", package = "findSVI"))

```
```{r}
phl_ct_svi_check <- cdc_svi_phl_2020 %>% 
  rename(
    GEOID = FIPS,
    CDC_SVI = RPL_THEMES,
    CDC_SVI1 = RPL_THEME1,
    CDC_SVI2 = RPL_THEME2,
    CDC_SVI3 = RPL_THEME3,
    CDC_SVI4 = RPL_THEME4
  ) %>%
  left_join(phl_ct_2020_svi_PA %>%
      rename(findSVI_SVI = RPL_themes),
    by = "GEOID") 

phl_ct_svi_check %>% 
  ggplot(aes(x = CDC_SVI, y = findSVI_SVI)) +
  geom_point()+
  geom_abline(slope = 1, intercept = 0, color = 'orange')+
  labs(title = "Tract-level overall SVI in Philadelphia (2020)",
       subtitle= "CDC/ATSDR vs. findSVI (ranking aganist tracts in PA)",
    x = "CDC",
    y = "findSVI")+
  theme_minimal()+
  theme(
    text = element_text(size = 13),
    plot.title = element_text(size = 16, hjust = 0, face = "bold"),
    plot.subtitle = element_text(color = "#4D4948", size = 13, hjust = 0),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 13)
  )

```

With a little peace of mind, we will now look at how SVI is affected if we use percentile ranks against all tracts in Philadelphia County instead of PA.

# SVI using ranks against tracts in Philadelphia

To retrieve census data and calculate SVI for a specific county, we need to use `get_census_data()` and `get_svi()` (as oppose to the one-step `find_svi` for state-level data processing). 

```{r, eval=FALSE}
phl_ct_2020_data <- get_census_dataata(
  2020, 
  state = "PA",
  county = "Philadelphia",
  geography = "tract"
)

phl_ct_svi_2020 <- get_svi(2020, phl_ct_2020_data)
```
```{r, echo=FALSE}
load(system.file("extdata", "phl_ct_svi_2020.rda", package = "findSVI"))
#no geometry
```

```{r, warning=FALSE}
svi_clean <- phl_ct_svi_2020 %>% 
  select(GEOID, contains("RPL_theme")) %>% 
  drop_na()
glimpse(svi_clean)
```
If we plot out overall SVI using the two different ranks, we can observe an interesting pattern, where they correlate well at both ends of the SVI spectrum but correlate poorly in the middle. Specifically, SVI using ranks against PA tracts (CDC) appears higher than using SVI using ranks against tracts within Philadelphia (findSVI). 

```{r}
join_svi <- cdc_svi_phl_2020 %>%
  rename(
    GEOID = FIPS,
    CDC_SVI = RPL_THEMES,
    CDC_SVI1 = RPL_THEME1,
    CDC_SVI2 = RPL_THEME2,
    CDC_SVI3 = RPL_THEME3,
    CDC_SVI4 = RPL_THEME4
  ) %>%
    left_join(svi_clean %>% 
        rename(findSVI_SVI = RPL_themes), 
      by = "GEOID") 


join_svi %>% 
  ggplot(aes(x = CDC_SVI, y = findSVI_SVI, color = findSVI_SVI)) +
  geom_point()+
  scale_color_gradient(low = "orange", high = "navy")+
  geom_abline(slope = 1, intercept = 0, color = 'orange')+
  labs(title = "Tract-level overall SVI in Philadelphia (2020)",
       subtitle= "Ranking aganist tracts in PA (CDC) vs. \nranking against tracts in Philadelphia (findSVI)",
    x = "CDC",
    y = "findSVI",
    color = "Overall SVI")+
  theme(
    text = element_text(size = 13),
    plot.title = element_text(size = 16, hjust = 0, face = "bold"),
    plot.subtitle = element_text(color = "#4D4948", size = 12, hjust = 0),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 13)
  )

```

Quantitatively, the correlation coefficient between two versions of SVI is `r {cor(join_svi$CDC_SVI, join_svi$findSVI_SVI)}`, suggesting a discrepancy that perhaps warrants more discussion. 

# What about another county?

--Montgomery, for example. 

Let's follow the same steps as above: 

* Select the tracts for Montgomery County from downloaded data (ranking against tracts within PA).

* Calculate SVI with findSVI for Montgomery County (ranking against tracts within the county) 

```{r, echo=FALSE}
load(system.file("extdata", "mont_ct_svi_2020.rda", package = "findSVI"))
```

```{r, eval=FALSE}
mont_data <- get_census_data(
  2020,
  state = "PA",
  county = "Montgomery",
  geography = "tract"
)

mont_ct_svi_2020 <- get_svi(2020, mont_data)
```

```{r}
mont_svi <- mont_ct_svi_2020 %>% 
  select(GEOID, contains("RPL_theme")) %>% 
  drop_na()

cdc_svi_mont_2020 <- cdc_svi_pa_ct_2020 %>%
  select(1:7, contains("RPL_THEME")) %>%
  filter(RPL_THEMES>= 0,
    COUNTY == "Montgomery")

join_svi2 <- cdc_svi_mont_2020 %>%
  rename(
    GEOID = FIPS,
    CDC_SVI = RPL_THEMES,
    CDC_SVI1 = RPL_THEME1,
    CDC_SVI2 = RPL_THEME2,
    CDC_SVI3 = RPL_THEME3,
    CDC_SVI4 = RPL_THEME4
  ) %>%
    left_join(mont_svi %>% 
        rename(findSVI_SVI = RPL_themes), 
      by = "GEOID") 


join_svi2 %>% 
  ggplot(aes(x = CDC_SVI, y = findSVI_SVI, color = findSVI_SVI)) +
  geom_point()+
  scale_color_gradient(low = "orange", high = "navy")+
  geom_abline(slope = 1, intercept = 0, color = 'orange')+
  labs(title = "Tract-level overall SVI in Montgomery County (2020)",
       subtitle= "Ranking aganist tracts in PA (CDC) vs. \nranking against tracts in Montgomery (findSVI)",
    x = "CDC",
    y = "findSVI",
    color = "Overall SVI")+
  theme(
    text = element_text(size = 13),
    plot.title = element_text(size = 14, hjust = 0, face = "bold"),
    plot.subtitle = element_text(color = "#4D4948", size = 12, hjust = 0),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 13)
  )

```

Mmm, there's also a discrepancy particularly in the middle of the SVI spectrum, but the curve is now "concave down"--SVI ranked against PA tracts (CDC) is lower than SVI ranked against Philadelphia tracts (findSVI). 

# Distribution of SVI variables

The difference in SVI obtained with percentile ranks against all tracts in PA versus all tracts within the county may be attributed to the data distribution. 

To compare distribution of SVI variables, we'll use percent estimate of each variable from PA, Philadelphia and Montgomery County. 

```{r}
df1 <- cdc_svi_pa_ct_2020 %>%
  select(GEOID = FIPS, contains("EP_")) %>%
  #adjunt var
  select(-c("EP_NOINT", "EP_AFAM", "EP_HISP", "EP_ASIAN",
    "EP_AIAN", "EP_NHPI", "EP_TWOMORE", "EP_OTHERRA")) %>%
  mutate(area = "PA")

df2 <- mont_ct_svi_2020 %>%
  select(GEOID, contains("EP_")) %>%
  mutate(area = "MONTCO")

df3 <- phl_ct_svi_2020 %>%
  select(GEOID, contains("EP_")) %>%
  mutate(area = "PHL")

density_df <- bind_rows(df1, df2, df3) %>%
  pivot_longer(cols = 2:17, names_to = "EP_var") %>%
  drop_na() %>%
  filter(value >= 0)

ggplot(data = density_df, aes(x = value, group = area, fill = area))+
  geom_density(adjust = 1.5, alpha = 0.4)+
  facet_wrap(~EP_var, scales = 'free')+
    theme_bw()+
  labs(title = "Distribution of Tract-level SVI Variables (2020)",
    x = "Percent estimate of each variable",
    fill = "Area")+
  theme(
    text = element_text(size = 10),
    plot.title = element_text(size = 14, hjust = 0, face = "bold"),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 13)
  )
  
```
Out of the 16 SVI variables, several show variation in data distribution among PA and the two counties, such as percentage of minority (EP_MINRTY), percentage of persons with no high school diploma (EP_NOHSDP), percentage of persons below 150% poverty (EP_POV150) and percentage uninsured in the noninstitutionalized population (EP_UNINSUR). In many of these cases, the values of SVI variables are concentrated at the lowest level for Montgomery County and the highest level for Philadelphia County, with PA in the middle.

# Two angles of a story

While SVI using percentile ranks against all PA tracts offers a broad perspective into community vulnerability relative to the state, SVI using ranks against tracts within the county (or region of interest) focuses on local context.

When examining the social vulnerability within a smaller region, especially metropolitan areas/cities, it may be helpful to consider the context during calculation to better understand the disparities between different communities. 
